services:
  etcd:
    image: gcr.io/etcd-development/etcd:v3.5.17
    command:
      - etcd
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd:2379
    ports:
      - "2379:2379"

  broker-1:
    build: .
    ports:
      - "6174:6174"
    environment:
      COMET_ADDR: ":6174"
      COMET_ADVERTISE_ADDR: "broker-1:6174"
      COMET_BROKER_ID: "broker-1"
      COMET_ETCD: "etcd:2379"
      COMET_DATA_DIR: "/data"
    depends_on:
      - etcd
    volumes:
      - comet-data-1:/data

  broker-2:
    build: .
    ports:
      - "6175:6174"
    environment:
      COMET_ADDR: ":6174"
      COMET_ADVERTISE_ADDR: "broker-2:6174"
      COMET_BROKER_ID: "broker-2"
      COMET_ETCD: "etcd:2379"
      COMET_DATA_DIR: "/data"
    depends_on:
      - etcd
    volumes:
      - comet-data-2:/data

  broker-3:
    build: .
    ports:
      - "6176:6174"
    environment:
      COMET_ADDR: ":6174"
      COMET_ADVERTISE_ADDR: "broker-3:6174"
      COMET_BROKER_ID: "broker-3"
      COMET_ETCD: "etcd:2379"
      COMET_DATA_DIR: "/data"
    depends_on:
      - etcd
    volumes:
      - comet-data-3:/data

  price-producer:
    build:
      context: .
      args:
        BUILD_TARGET: ./examples/price-producer
    environment:
      BROKER_ADDR: "broker-1:6174,broker-2:6174,broker-3:6174"
    depends_on:
      - broker-1
      - broker-2
      - broker-3
    restart: on-failure

  price-alert-1:
    build:
      context: .
      args:
        BUILD_TARGET: ./examples/price-alert
    environment:
      BROKER_ADDR: "broker-1:6174,broker-2:6174,broker-3:6174"
    depends_on:
      - broker-1
      - broker-2
      - broker-3
    restart: on-failure

  price-alert-2:
    build:
      context: .
      args:
        BUILD_TARGET: ./examples/price-alert
    environment:
      BROKER_ADDR: "broker-1:6174,broker-2:6174,broker-3:6174"
    depends_on:
      - broker-1
      - broker-2
      - broker-3
    restart: on-failure

volumes:
  comet-data-1:
  comet-data-2:
  comet-data-3:
